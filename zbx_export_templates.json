{
    "zabbix_export": {
        "version": "5.2",
        "date": "2021-05-18T10:26:55Z",
        "groups": [
            {
                "name": "Templates/Modules"
            }
        ],
        "templates": [
            {
                "template": "SSL and TLS cert validity and service availability",
                "name": "SSL and TLS cert validity and service availability",
                "description": "It's a custom template by Ihor Romanyshyn based on https://github.com/selivan/https-ssl-cert-check-zabbix script. The script must be placed at the ExternalScripts directory defined in the zabbix_server.conf file.",
                "groups": [
                    {
                        "name": "Templates/Modules"
                    }
                ],
                "applications": [
                    {
                        "name": "SSL and TLS"
                    }
                ],
                "items": [
                    {
                        "name": "HTTPS service is running",
                        "type": "SIMPLE",
                        "key": "net.tcp.service[https,{HOST.CONN},{$SSL_PORT}]",
                        "history": "1w",
                        "applications": [
                            {
                                "name": "SSL and TLS"
                            }
                        ],
                        "valuemap": {
                            "name": "Service state"
                        }
                    },
                    {
                        "name": "Certificate expire",
                        "type": "EXTERNAL",
                        "key": "ssl_cert_check.sh[\"expire\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"]",
                        "value_type": "FLOAT",
                        "units": "days",
                        "applications": [
                            {
                                "name": "SSL and TLS"
                            }
                        ],
                        "triggers": [
                            {
                                "expression": "{change()}>0",
                                "name": "The certificate has been replaced on {HOST.NAME} (service {$SSL_PORT})",
                                "priority": "INFO",
                                "description": "The certificate for the domain appears to be replaced because its validity date changed.",
                                "manual_close": "YES"
                            },
                            {
                                "expression": "{last()}<7",
                                "name": "The certificate on {HOST.NAME} (service {$SSL_PORT}) expires in less than 7 days",
                                "priority": "AVERAGE",
                                "description": "{ITEM.LASTVALUE1} to expire",
                                "dependencies": [
                                    {
                                        "name": "The certificate on {HOSTNAME} (service {$SSL_PORT}) is expired",
                                        "expression": "{SSL and TLS cert validity and service availability:ssl_cert_check.sh[\"expire\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"].last()}<0"
                                    }
                                ]
                            },
                            {
                                "expression": "{last()}<{$SSL_DAYS}",
                                "name": "The certificate on {HOSTNAME} (service {$SSL_PORT}) expires in less than {$SSL_DAYS} days",
                                "priority": "WARNING",
                                "description": "{ITEM.LASTVALUE1} to expire",
                                "dependencies": [
                                    {
                                        "name": "The certificate on {HOST.NAME} (service {$SSL_PORT}) expires in less than 7 days",
                                        "expression": "{SSL and TLS cert validity and service availability:ssl_cert_check.sh[\"expire\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"].last()}<7"
                                    }
                                ]
                            },
                            {
                                "expression": "{last()}<0",
                                "name": "The certificate on {HOSTNAME} (service {$SSL_PORT}) is expired",
                                "priority": "HIGH",
                                "description": "{ITEM.LASTVALUE1}",
                                "dependencies": [
                                    {
                                        "name": "The certificate on {HOSTNAME} (service {$SSL_PORT}) is invalid",
                                        "expression": "{SSL and TLS cert validity and service availability:ssl_cert_check.sh[\"valid\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"].last()}=0"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Certificate validity",
                        "type": "EXTERNAL",
                        "key": "ssl_cert_check.sh[\"valid\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"]",
                        "value_type": "FLOAT",
                        "applications": [
                            {
                                "name": "SSL and TLS"
                            }
                        ],
                        "valuemap": {
                            "name": "SSL cert validity"
                        },
                        "triggers": [
                            {
                                "expression": "{last()}=0",
                                "name": "The certificate on {HOSTNAME} (service {$SSL_PORT}) is invalid",
                                "priority": "HIGH",
                                "description": "The certificate appears to be revoked, self-signed, or improperly installed. Anyway, it can't be trusted."
                            }
                        ]
                    }
                ],
                "macros": [
                    {
                        "macro": "{$SSL_DAYS}",
                        "value": "21",
                        "description": "When to trigger alarm, but there's also a trigger on 7 days left predefined."
                    },
                    {
                        "macro": "{$SSL_PORT}",
                        "value": "443",
                        "description": "Default port 443 is for HTTPS service with SSL. But the next protocols currently supported for TLS also: \"smtp\", \"pop3\", \"imap\", \"ftp\", \"xmpp\", \"xmpp-server\", \"irc\", \"postgres\", \"mysql\", \"lmtp\", \"nntp\", \"sieve\" and \"ldap\". To check the TLS protocol, use it like this: \"636/ldap\". Also, \"443/tls\" may work."
                    }
                ]
            }
        ],
        "triggers": [
            {
                "expression": "({SSL and TLS cert validity and service availability:ssl_cert_check.sh[\"expire\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"].nodata(300)}=1)\nor\n({SSL and TLS cert validity and service availability:ssl_cert_check.sh[\"valid\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"].nodata(300)}=1)",
                "name": "No data about certificate at {HOST.NAME} (service {$SSL_PORT})",
                "priority": "WARNING"
            }
        ],
        "graphs": [
            {
                "name": "HTTPS service status",
                "graph_items": [
                    {
                        "sortorder": "1",
                        "drawtype": "BOLD_LINE",
                        "color": "FF0000",
                        "item": {
                            "host": "SSL and TLS cert validity and service availability",
                            "key": "net.tcp.service[https,{HOST.CONN},{$SSL_PORT}]"
                        }
                    },
                    {
                        "sortorder": "2",
                        "drawtype": "DASHED_LINE",
                        "color": "2774A4",
                        "item": {
                            "host": "SSL and TLS cert validity and service availability",
                            "key": "ssl_cert_check.sh[\"valid\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"]"
                        }
                    },
                    {
                        "sortorder": "3",
                        "drawtype": "DASHED_LINE",
                        "color": "F7941D",
                        "yaxisside": "RIGHT",
                        "item": {
                            "host": "SSL and TLS cert validity and service availability",
                            "key": "ssl_cert_check.sh[\"expire\",\"{HOST.CONN}\",\"{$SSL_PORT}\",\"{HOST.DNS}\"]"
                        }
                    }
                ]
            }
        ],
        "value_maps": [
            {
                "name": "Service state",
                "mappings": [
                    {
                        "value": "0",
                        "newvalue": "Down"
                    },
                    {
                        "value": "1",
                        "newvalue": "Up"
                    }
                ]
            },
            {
                "name": "SSL cert validity",
                "mappings": [
                    {
                        "value": "0",
                        "newvalue": "invalid"
                    },
                    {
                        "value": "1",
                        "newvalue": "valid"
                    }
                ]
            }
        ]
    }
}